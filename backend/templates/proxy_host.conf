{% include "_header_comment.conf" %}

{% if enabled %}

{% include "_hsts_map.conf" %}


#todo 开启缓存
lua_code_cache off;
{% if block_exploits == 1 or block_exploits == true or   block_exploits == 1 or block_exploits == true  %}
 lua_package_path '/etc/nginx/lua/scripts/?.lua;;/etc/nginx/lua/module/?.lua;;/etc/nginx/lua/plugins/?.lua;;/etc/nginx/lua/waf_detectors/?.lua;;';
{% endif %}

server {
  set $forward_scheme {{ forward_scheme }};
  set $server         "{{ forward_host }}";
  set $port           {{ forward_port }};


access_by_lua_block {

local function tableToString(tbl)
    local str = "{"
    for k, v in pairs(tbl) do
        if type(k) == "number" then
            str = str .. "[" .. k .. "]="
        else
            str = str .. k .. "="
        end
        if type(v) == "table" then
            str = str .. tableToString(v) .. ","
        else
            str = str .. tostring(v) .. ","
        end
    end
    -- Remove the trailing comma if it exists
    if str:sub(-1) == "," then
        str = str:sub(1, -2)
    end
    str = str .. "}"
    return str
end

  {% if block_exploits == 1 or block_exploits == true %}
local test_str="";
for module, path in pairs(package.loaded) do
     test_str= test_str..module.."|"..tableToString(path).."\n"
end


{% endif %}

{% if anti_ddos == 1 or anti_ddos == true %}  

  local antiDdos = require("anti_ddos")
  antiDdos()

{% endif %}

}


{% include "_listen.conf" %}
{% include "_certificates.conf" %}
{% include "_assets.conf" %}

{% include "_hsts.conf" %}
{% include "_forced_ssl.conf" %}

{% if allow_websocket_upgrade == 1 or allow_websocket_upgrade == true %}
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
proxy_http_version 1.1;
{% endif %}

  access_log /data/logs/proxy-host-{{ id }}_access.log proxy;
  error_log /data/logs/proxy-host-{{ id }}_error.log warn;

{{ advanced_config }}

{{ locations }}

{% if use_default_location %}
  
 location / {



{% include "_access.conf" %}
{% include "_hsts.conf" %}

    {% if allow_websocket_upgrade == 1 or allow_websocket_upgrade == true %}
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_http_version 1.1;
    {% endif %}

    # Proxy!
    include conf.d/include/proxy.conf;
  }
{% endif %}

  # Custom
  include /data/nginx/custom/server_proxy[.]conf;
}
{% endif %}
